<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Order System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Remove mobile tap highlight */
        }

        :root {
            --primary: #E07A5F;
            --secondary: #81B29A;
            --background: #F5F5F5;
            --text: #2D2D2D;
            --highlight: #FFF8F6;
        }

        body {
            display: flex;
            height: 100vh;
            background: var(--background);
            overflow: hidden;
        }

        /* Left Panel */
        .order-panel {
            width: 33.33%;
            padding: 1.5rem;
            border-right: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-details {
            flex: 1;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        /* Numpad Styling - Enhanced for Touch & Width */
		.numpad {
			display: grid;
			grid-template-columns: repeat(3, 1fr); /* 3 equal columns */
			gap: 0.75rem;
			margin-top: 1rem;
			width: 100%; /* This should make the grid container use full available width */
			/* Let's ensure its parent doesn't overly constrain it with padding for this specific element */
		}

		.numpad button {
			min-height: 5rem; /* Or even more if they look too narrow, e.g., 5.5rem or 6rem */
			/* Width is driven by '1fr' in grid-template-columns */
			padding: 0.5rem; /* Adjust padding if text gets cramped with larger font */
			border: 1px solid #ddd;
			background: white;
			border-radius: 8px;
			font-size: 2.2rem; /* Try increasing font size even more */
			font-weight: 500;
			color: var(--text);
			cursor: pointer;
			transition: all 0.15s ease-out;
			box-shadow: 0 3px 6px rgba(0,0,0,0.08);
			display: flex;
			align-items: center;
			justify-content: center;
			line-height: 1;
		}

		.numpad button:active {
			transform: scale(0.96);
			background-color: #e9e9e9;
			box-shadow: 0 1px 3px rgba(0,0,0,0.06);
		}

		.numpad button.numpad-action-btn {
			background-color: var(--secondary);
			color: white;
			font-size: 1.8rem; /* May need adjustment for 'C' or '‚Üê' symbols */
		}

		.numpad button.numpad-action-btn:active {
			background-color: #6a9a80;
		}

        /* Right Panel */
        .menu-panel {
            width: 66.67%;
			padding: 1.5rem;
			overflow-y: auto;
			height: 100vh; /* Add this to ensure proper height */
        }

        /* Category Tabs Container */
		.category-tabs {
			display: flex;
			flex-wrap: wrap;
			gap: 0.75rem;
			margin-bottom: 1.5rem;
			padding-bottom: 1rem;
			border-bottom: 1px solid #e0e0e0; /* This should add the line */
		}

		/* Individual Category Tab (Pill) - Inactive State */
		.category-tab {
			padding: 0.75rem 1.5rem;
			border: 1px solid #d0d0d0;    /* This should add the border */
			border-radius: 24px;
			background: white;            /* This should make them white */
			color: var(--text);
			cursor: pointer;
			font-size: 1rem;
			white-space: nowrap;
			min-width: fit-content;
			transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
		}

		.category-tab:hover {
			border-color: #a0a0a0;
			background-color: #f9f9f9;
		}

		/* Active tab style - make sure this comes AFTER the default .category-tab styles */
		.category-tab.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}

        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .product-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
            min-height: 6rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-card:active {
            transform: scale(0.98);
            background: var(--highlight);
        }
		
		.product-card h3 {
			margin-bottom: 0.5rem; /* Add some space between name and price if name is short */
			/* The following properties enable multi-line ellipsis */
			display: -webkit-box;
			-webkit-box-orient: vertical;
			-webkit-line-clamp: 2; /* Show a maximum of 2 lines */
			overflow: hidden;
			text-overflow: ellipsis;
			/* Fallback for non-WebKit browsers (might only work for single line effectively without JS) */
			/* For single line ellipsis as a simpler fallback:
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			*/
			/* We need to ensure h3 can have a height that accommodates two lines */
			/* The flex properties on .product-card should allow this.
			   If card min-height is an issue, this might need adjustment.
			   Let's assume min-height: 6rem on product-card is enough. */
		}

        /* Order Items */
        .order-item {
			padding: 0.75rem 0;
			border-bottom: 1px solid #eee;
			display: flex;
			justify-content: space-between;
			align-items: center; /* ADD THIS LINE for vertical centering */
			animation: fadeIn 0.3s ease-out;
		}

        .order-item.new {
            background: var(--highlight);
            border-left: 3px solid var(--primary);
            padding-left: 0.5rem;
            margin-left: -0.5rem;
        }
		
		.order-item-actions {
			display: flex;
			align-items: center; 
			gap: 0.5rem; 
			margin-left: 0.75rem; 
		}
		
		.order-item-actions .secondary-btn {
			padding: 0.6rem 0.8rem; 
			font-size: 1.2rem;  
			min-width: 2.8rem;  
			min-height: 2.8rem; 
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .action-buttons button {
            flex: 1;
            padding: 1.25rem;
            font-size: 1.1rem;
        }

        .primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
        }

        .secondary-btn {
            background: #ddd;
            border: none;
            border-radius: 8px;
            font-weight: 500;
        }
		
		.order-item .secondary-btn {
			padding: 0.6rem 0.8rem;  /* Makes the button bigger */
			font-size: 1.2rem;     /* Makes the icon/text inside bigger */
			min-width: 2.8rem;     /* Ensures a minimum tap width */
			min-height: 2.8rem;    /* Ensures a minimum tap height */
			display: inline-flex;
			align-items: center;
			justify-content: center;
			margin-left: 0.5rem; /* Keeps a small gap to the left */
		}

        /* Utility */
        .price {
            color: var(--primary);
            font-weight: 700;
        }

        .text-lg {
            font-size: 1.2rem;
        }

        .text-bold {
            font-weight: 700;
        }
        
         /* Management Modal Styles */
    .management-modal {
		display: none; /* Initially hidden, JS will set it to 'flex' */
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0,0,0,0.5);
		z-index: 1000;
		padding: 2rem;
		/* These are key for centering its child, .management-content */
		align-items: center;
		justify-content: center;
		/* overflow: hidden; /* Optional: good to prevent overlay scroll if content somehow overflows it */
	}
	
	.management-modal .form-actions button,
		#itemOptionSelectModal .form-actions button {
			padding: 0.8rem 1.5rem;
			font-size: 1rem;
			font-weight: 500;
			border-radius: 8px;
			border: none; /* Ensure no border */
			text-align: center;
			height: 3rem; /* Explicit height */
			display: inline-flex; /* For centering content */
			align-items: center;
			justify-content: center;
			/* flex-grow: 1; /* Removed */
			/* Add a min-width if they become too narrow */
			min-width: 100px; /* Example: Adjust as needed */
		}
		
		#itemOptionSelectModal .form-actions {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 0.75rem;
		}

		#itemOptionSelectModal .form-actions button {
			width: 100%;
			margin: 0;
		}

	/* Ensure the primary and secondary styles are maintained if the above is more specific */
	.management-modal .form-actions .primary-btn,
	#itemOptionSelectModal .form-actions .primary-btn {
		background: var(--primary);
		color: white;
		border: none;
	}

	.management-modal .form-actions .secondary-btn,
	#itemOptionSelectModal .form-actions .secondary-btn {
		background: #ddd; /* Your existing secondary button background */
		color: var(--text); /* Ensure good contrast if default is not clear */
		border: none;
	}

	.management-content {
		background: white;
		max-width: 600px;
		width: 100%;
		margin: 0; /* IMPORTANT: Let the flex parent handle margins for centering */
		border-radius: 8px;
		padding: 1.5rem;
		max-height: calc(100vh - 4rem); /* Max height considering modal's top/bottom padding */
		overflow-y: auto;   /* Makes the content scrollable if it exceeds max-height */
		display: block;     /* This is fine, or flex; flex-direction: column; */
	}

    .management-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .management-tab {
        padding: 0.5rem 1rem;
        border: none;
        background: #eee;
        border-radius: 4px;
        cursor: pointer;
    }

    .management-tab.active {
        background: var(--primary);
        color: white;
    }

    .management-form {
        display: grid;
        gap: 1rem;
    }
	
	.management-form input, 
	.management-form select {
		padding: 1rem !important;
		font-size: 1.1rem !important;
		min-height: 50px;
	}

    .form-group {
        display: grid;
        gap: 0.5rem;
    }

    input, select {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .item-list {
        margin-top: 1rem;
        border-top: 1px solid #eee;
        padding-top: 1rem;
    }
	
	#itemsManagement .item-list {
		max-height: 300px; /* You can change 300px to a different value if needed */
		overflow-y: auto;
		padding-right: 10px; /* Optional: for better spacing with the scrollbar */
	}
	
	#categoriesManagement .item-list {
		max-height: 300px; /* You can change 300px to a different value if needed */
		overflow-y: auto;
		padding-right: 10px; /* Optional: for better spacing with the scrollbar */
	}

    .item-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }

    .settings-gear {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: var(--primary);
        color: white;
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .selected-item {
            background: var(--highlight) !important;
            border: 2px solid var(--primary) !important;
        }

    .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            animation: slideDown 0.3s ease-out;
            display: none;
        }

    @keyframes slideDown {
            from { top: -50px; }
            to { top: 20px; }
        }
        
        /* Printer-friendly styles */
    @media print {
        body > :not(.print-section) {
            display: none !important;
        }
        .print-section {
            padding: 20px;
            font-size: 14pt;
        }
    }

    /* Kitchen ticket styling */
    .kitchen-ticket {
        display: none;
        background: white;
        padding: 20px;
        max-width: 400px;
        margin: 0 auto;
        border: 3px dashed #ccc;
    }
	
	/* Management Modal Button Styles */
		.management-content .primary-btn {
			padding: 1rem !important;
			font-size: 1.1rem !important;
			margin-top: 1rem;
			height: auto;
			min-height: 50px; /* Minimum touch target size */
		}

	/* Form submit buttons */
		.management-form button {
			width: 100%;
			padding: 1rem !important;
			font-size: 1.1rem !important;
			margin: 0.5rem 0;
		}

	/* Edit/Delete buttons in lists */
		.item-row button {
			padding: 0.75rem 1rem !important;
			min-width: 80px;
			font-size: 1rem !important;
	}

	/* Make category tabs more touch-friendly */
		.management-tabs button {
			padding: 0.75rem 1.5rem !important;
			font-size: 1rem !important;
	}
	button {
		transition: transform 0.1s, background-color 0.2s;
	}

	button:active {
		transform: scale(0.96);
	}

	.primary-btn:active {
		background: #c0392b !important; /* Darker shade of your primary color */
	}
	
	#existingItems .item-row.editing {
		background-color: var(--highlight); /* Use your highlight color */
		border-left: 3px solid var(--primary); /* Add a distinct left border */
		/* font-weight: 500; /* Optional: make text slightly bolder */
	}
	
	.options-badge {
		font-size: 0.65em; /* Small badge */
		font-weight: 500;
		background-color: var(--secondary); /* Or another subtle color */
		color: white;
		padding: 2px 5px;
		border-radius: 3px;
		margin-left: 8px;
		white-space: nowrap;
		align-self: center; /* Align with the item name if in a flex container */
	}
	
	.option-pill {
		display: inline-flex;
		align-items: center;
		background-color: var(--secondary); /* Using your secondary color for pills */
		color: white;
		padding: 0.4rem 0.8rem;
		border-radius: 16px; /* Pill shape */
		font-size: 0.9em;
		/* margin-right: 0.5rem; /* Gap is handled by parent flex container */
		/* margin-bottom: 0.5rem; /* Gap is handled by parent flex container */
		line-height: 1;
	}

	.option-pill .remove-option-btn { /* The 'x' button inside the pill */
		background: none;
		border: none;
		color: white;
		margin-left: 0.6rem;
		cursor: pointer;
		font-size: 1.2em; /* Make 'x' a bit larger */
		padding: 0;
		line-height: 0.5; /* Adjust for better vertical alignment of '√ó' */
		font-weight: bold;
	}

	.option-pill .remove-option-btn:hover {
		color: #ffd0d0; /* Light red hover for delete */
	}
    </style>
</head>
<body>
    <!-- Left Panel -->
    <div class="order-panel">
        <div class="order-details">
            <h2>Order #<span id="order-number">1</span></h2>
            <div id="order-items"></div>
            <div id="order-total" class="text-lg text-bold">Total: $0.00</div>
        </div>
        
        <div class="numpad"> <button onclick="handleNumpad(1)">1</button>
			   <button onclick="handleNumpad(2)">2</button>
			   <button onclick="handleNumpad(3)">3</button>
			   <button onclick="handleNumpad(4)">4</button>
			   <button onclick="handleNumpad(5)">5</button>
			   <button onclick="handleNumpad(6)">6</button>
			   <button onclick="handleNumpad(7)">7</button>
			   <button onclick="handleNumpad(8)">8</button>
			   <button onclick="handleNumpad(9)">9</button>
			   <button class="numpad-action-btn" onclick="handleNumpadClear()">C</button>
			   <button onclick="handleNumpad(0)">0</button> <button class="numpad-action-btn" onclick="handleNumpadBackspace()">‚Üê</button>
        </div>
		
		<div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
			<label for="universalOrderCommentInput" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Order Notes:</label>
			<textarea id="universalOrderCommentInput" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"></textarea>
		</div>

        <div class="action-buttons">
            <button class="secondary-btn" onclick="newOrder()">New Order</button>
            <button class="primary-btn" onclick="sendOrder()">Send Order</button>
        </div>
    </div>

    <!-- Right Panel -->
    <div class="menu-panel">
        <div class="category-tabs" id="categories">
            <!-- Categories will be injected via JS -->
        </div>
        
        <div class="product-grid" id="products">
            <!-- Products will be injected via JS -->
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // Initialize with localStorage
		let menu = {};
        let selectedCategory = null;
        let editingItem = null;
        let currentManagementTab = 'items';
        let currentOrder = JSON.parse(localStorage.getItem('currentOrder')) || [];
        let selectedItemId = null; 
        let tempItemOptions = [];
        let currentItemWithOptions = null; 
        let numpadInput = "";
        let universalOrderComment = localStorage.getItem('universalOrderComment') || "";

        const ORDER_NUMBER_KEY = 'dailyOrderNumber';
        const LAST_ORDER_DATE_KEY = 'lastOrderDate';
        let orderNumber; 

        function getLocalDateStr() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function loadMenu() {
            try {
                const response = await fetch('/api/menu');
                menu = await response.json() || {};
                if (Object.keys(menu).length > 0) {
                    selectedCategory = Object.keys(menu)[0];
                }
                init();
            } catch (error) {
                showToast('Error loading menu');
                console.error(error);
            }
        }

        async function saveMenuToServer() {
            try {
                await fetch('/api/menu', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(menu)
                });
            } catch (error) {
                showToast('Failed to save menu');
                console.error(error);
            }
        }

        function initializeOrderNumberAndDate() {
            const todayStr = getLocalDateStr();
            const storedLastOrderDate = localStorage.getItem(LAST_ORDER_DATE_KEY);
            const storedOrderNumber = parseInt(localStorage.getItem(ORDER_NUMBER_KEY));

            if (storedLastOrderDate === todayStr && !isNaN(storedOrderNumber) && storedOrderNumber > 0) {
                orderNumber = storedOrderNumber;
            } else {
                orderNumber = 1;
            }
            localStorage.setItem(LAST_ORDER_DATE_KEY, todayStr);
            localStorage.setItem(ORDER_NUMBER_KEY, orderNumber);
        }

        function init() {
            const categoriesDiv = document.getElementById('categories');
            categoriesDiv.innerHTML = '';
    
            Object.keys(menu).forEach(category => {
                const btn = document.createElement('button');
                btn.className = `category-tab ${category === selectedCategory ? 'active' : ''}`;
                btn.textContent = category;
                btn.onclick = () => {
                    document.querySelectorAll('.category-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    btn.classList.add('active');
                    showCategory(category);
                };
                categoriesDiv.appendChild(btn);
            });
            
            const universalCommentInputEl = document.getElementById('universalOrderCommentInput');
            if (universalCommentInputEl) {
                universalCommentInputEl.value = universalOrderComment;
                universalCommentInputEl.addEventListener('input', (e) => {
                    universalOrderComment = e.target.value;
                    localStorage.setItem('universalOrderComment', universalOrderComment);
                });
            }

            if (selectedCategory) {
                showCategory(selectedCategory);
            }
            document.getElementById('order-number').textContent = orderNumber;
            updateOrderDisplay();
        }
        
        function generateItemId() {
            const allItems = [].concat(...Object.values(menu).map(categoryItems => categoryItems || []));
            return allItems.length > 0 ? Math.max(0, ...allItems.map(i => i.id)) + 1 : 1;
        }

        function showCategory(category) {
            selectedCategory = category;
            const productsDiv = document.getElementById('products');
            productsDiv.innerHTML = ''; 

            if (menu[category] && menu[category].length > 0) {
                menu[category].forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'product-card';

                    let optionsBadgeHTML = '';
                    if (item.options && Array.isArray(item.options) && item.options.length > 0) {
                        optionsBadgeHTML = `<span class="options-badge">Options</span>`;
                    }

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h3 title="${item.name}">${item.name}</h3>
                            ${optionsBadgeHTML}
                        </div>
                        <div class="price">$${item.price.toFixed(2)}</div>
                    `;
                    card.onclick = () => addToOrder(item.id);
                    productsDiv.appendChild(card);
                });
            } else {
                productsDiv.innerHTML = '<p style="text-align: center; width: 100%;">No items in this category.</p>';
            }
        }

        function addToOrder(itemId) {
            let menuItem;
            Object.values(menu).forEach(categoryItems => {
                const found = (categoryItems || []).find(i => i.id === itemId);
                if (found) menuItem = found;
            });

            if (!menuItem) {
                console.error("Menu item not found:", itemId);
                return;
            }

            if (menuItem.options && Array.isArray(menuItem.options) && menuItem.options.length > 0) {
                openItemOptionSelectModal(menuItem);
            } else {
                const existingOrderItem = currentOrder.find(orderItem => orderItem.id === menuItem.id && !orderItem.selectedOption);

                if (existingOrderItem) {
                    existingOrderItem.quantity++;
                } else {
                    const newOrderItem = { ...menuItem, quantity: 1, comment: "" };
                    newOrderItem.orderId = String(menuItem.id); 
                    currentOrder.push(newOrderItem);
                }
                updateOrderDisplay();
            }
        }

        function openItemOptionSelectModal(menuItem) {
            currentItemWithOptions = menuItem;
            const modal = document.getElementById('itemOptionSelectModal');
            const itemNameEl = document.getElementById('optionModalItemName');
            const optionsContainerEl = document.getElementById('optionModalOptionsContainer');

            itemNameEl.textContent = `Select Option for: ${menuItem.name}`;
            optionsContainerEl.innerHTML = '';

            if (menuItem.options && menuItem.options.length > 0) {
                menuItem.options.forEach((option, index) => {
                    const optionId = `item_option_${menuItem.id}_${index}`;
                    const div = document.createElement('div');
                    div.style.padding = "0.5rem";
                    div.style.border = "1px solid #eee";
                    div.style.borderRadius = "4px";
                    div.style.cursor = "pointer";
                    div.onclick = () => { 
                        const radioBtn = document.getElementById(optionId);
                        if(radioBtn) radioBtn.checked = true; 
                        document.querySelectorAll('#optionModalOptionsContainer div').forEach(d => d.style.borderColor = '#eee');
                        div.style.borderColor = 'var(--primary)';
                    };

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `item_option_for_${menuItem.id}`;
                    radio.id = optionId;
                    radio.value = option;
                    if (index === 0) {
                        radio.checked = true;
                        div.style.borderColor = 'var(--primary)';
                    }

                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.textContent = option;
                    label.style.marginLeft = "0.5rem";
                    label.style.cursor = "pointer";

                    div.appendChild(radio);
                    div.appendChild(label);
                    optionsContainerEl.appendChild(div);
                });
            } else {
                optionsContainerEl.textContent = "No options available for this item.";
            }
            if (modal) modal.style.display = 'flex';
        }

        function cancelOptionSelection() {
            const modal = document.getElementById('itemOptionSelectModal');
            if (modal) modal.style.display = 'none';
            currentItemWithOptions = null;
        }

        function confirmOptionSelection() {
            if (!currentItemWithOptions) return;

            const optionsContainerEl = document.getElementById('optionModalOptionsContainer');
            const selectedRadio = optionsContainerEl.querySelector('input[type="radio"]:checked');

            if (!selectedRadio) {
                showToast("Please select an option.");
                return;
            }
            const selectedOptionValue = selectedRadio.value;
            const orderItemIdWithOption = `${currentItemWithOptions.id}-${selectedOptionValue.replace(/\s+/g, '_')}`;

            const existingOrderItem = currentOrder.find(
                orderItem => orderItem.orderId === orderItemIdWithOption
            );

            if (existingOrderItem) {
                existingOrderItem.quantity++;
            } else {
                const newOrderItem = { 
                    ...currentItemWithOptions, 
                    orderId: orderItemIdWithOption,
                    quantity: 1, 
                    comment: "", 
                    selectedOption: selectedOptionValue 
                };
                currentOrder.push(newOrderItem);
            }
            updateOrderDisplay();
            cancelOptionSelection();
        }
        
        function updateOrderDisplay() {
            const orderItemsDiv = document.getElementById('order-items');
            orderItemsDiv.innerHTML = '';
            
            currentOrder.forEach(item => {
                const div = document.createElement('div');
                const uniqueDisplayId = item.orderId ? String(item.orderId) : String(item.id); 

                div.className = `order-item ${uniqueDisplayId === selectedItemId ? 'selected-item' : ''}`;
                
                let optionDisplayHTML = '';
                if (item.selectedOption) {
                    optionDisplayHTML = `<div style="font-size: 0.8em; color: #777; margin-left: 10px;">‚Ü≥ ${item.selectedOption}</div>`;
                }

                div.innerHTML = `
                <div style="flex: 1;">
                    <span>${item.quantity}x ${item.name}</span>
                    ${optionDisplayHTML}
                    ${item.comment ? `<div style="font-size: 0.8em; color: #555; margin-left: 10px;"><em>Note: ${item.comment}</em></div>` : ''}
                </div>
                <span class="price" style="text-align: right;">$${(item.price * item.quantity).toFixed(2)}</span>
                <div class="order-item-actions">
                    <button onclick="event.stopPropagation(); promptForItemComment('${uniqueDisplayId}')" class="secondary-btn" title="Add Note">‚úé</button> 
                    <button onclick="event.stopPropagation(); removeItemByOrderId('${uniqueDisplayId}')" class="secondary-btn" title="Remove Item">√ó</button>
                </div>
                `;
                div.onclick = () => selectItemByOrderId(uniqueDisplayId); 
                orderItemsDiv.appendChild(div);
            });

            const total = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('order-total').textContent = `Total: $${total.toFixed(2)}`;
            
            localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
        }
        
        function selectItemByOrderId(orderId) {
            if (selectedItemId === orderId) {
                 selectedItemId = orderId; 
                 numpadInput = "";
            } else {
                selectedItemId = orderId;
                numpadInput = "";    
            }
            updateOrderDisplay();
        }

        function removeItemByOrderId(orderId) {
            currentOrder = currentOrder.filter(item => (item.orderId ? String(item.orderId) : String(item.id)) !== orderId);
            if (selectedItemId === orderId) { 
                selectedItemId = null;
                numpadInput = "";
            }
            updateOrderDisplay();
        }

        function promptForItemComment(orderId) { 
            const item = currentOrder.find(i => (i.orderId ? String(i.orderId) : String(i.id)) === orderId);
            if (item) {
                const newComment = prompt("Enter note for " + item.name + (item.selectedOption ? ` (${item.selectedOption})` : '') + ":", item.comment || "");
                if (newComment !== null) { 
                    item.comment = newComment.trim();
                    updateOrderDisplay(); 
                    localStorage.setItem('currentOrder', JSON.stringify(currentOrder)); 
                }
            }
        }

        function handleNumpad(digit) { 
            if (!selectedItemId) {
                showToast('Select an item first');
                numpadInput = ""; 
                return;
            }
            const item = currentOrder.find(i => (i.orderId ? String(i.orderId) : String(i.id)) === selectedItemId);
            if (!item) {
                showToast('Error: Selected item not found in order for numpad.');
                numpadInput = ""; 
                return;
            }

            if (numpadInput === "0" && String(digit) !== "0") {
                numpadInput = String(digit);
            } else {
                numpadInput += String(digit); 
            }
            
            let newQuantity = Number(numpadInput);

            if (isNaN(newQuantity) || newQuantity <= 0) {
                item.quantity = 1;
                if (Number(numpadInput) <=0 && numpadInput !== "0") { 
                     numpadInput = "1"; 
                } else if (numpadInput === "0") {
                    // Allow "0" to be typed, but quantity will be 1
                } else {
                     numpadInput = "1";
                }           
            } else {
                item.quantity = newQuantity;
            }
            updateOrderDisplay();
        }

        function handleNumpadClear() {
            if (!selectedItemId) {
                showToast('Select an item first');
                return;
            }
            const item = currentOrder.find(i => (i.orderId ? String(i.orderId) : String(i.id)) === selectedItemId);
            if (item) {
                numpadInput = "";
                item.quantity = 1;
                showToast('Input cleared. Quantity set to 1.');
                updateOrderDisplay();
            }
        }

        function handleNumpadBackspace() {
            if (!selectedItemId) {
                showToast('Select an item first');
                return;
            }
            const item = currentOrder.find(i => (i.orderId ? String(i.orderId) : String(i.id)) === selectedItemId);
            if (item) {
                if (numpadInput.length > 0) {
                    numpadInput = numpadInput.slice(0, -1);
                }

                if (numpadInput === "") {
                    item.quantity = 1;
                } else {
                    let newQuantity = Number(numpadInput);
                    item.quantity = (newQuantity > 0) ? newQuantity : 1;
                }
                updateOrderDisplay();
            }
        }

        function newOrder() {
            currentOrder = [];
            const todayStr = getLocalDateStr();
            const storedLastOrderDate = localStorage.getItem(LAST_ORDER_DATE_KEY);

            if (storedLastOrderDate !== todayStr) {
                orderNumber = 1;
                localStorage.setItem(LAST_ORDER_DATE_KEY, todayStr);
            } else {
                orderNumber++;
            }
            localStorage.setItem(ORDER_NUMBER_KEY, orderNumber);
            document.getElementById('order-number').textContent = orderNumber;

            numpadInput = "";
            selectedItemId = null;
            universalOrderComment = "";
            localStorage.removeItem('universalOrderComment');
            const universalCommentInputEl = document.getElementById('universalOrderCommentInput');
            if (universalCommentInputEl) universalCommentInputEl.value = "";
            updateOrderDisplay();
            showToast('New order started');
        }

        async function sendOrder() {
            if (!currentOrder.length) return showToast('Order is empty!');
            const orderData = {
                number: orderNumber,
                items: currentOrder,
                universalComment: universalOrderComment
            };
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                if (response.ok) {
                    showToast(`Order #${orderNumber} sent!`);
                    newOrder();
                } else {
                    const errorResult = await response.json().catch(() => ({ message: 'Failed to send order and parse error' }));
                    showToast(`Failed to send order: ${errorResult.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Send order error:', error);
                showToast('Network error - check server connection.');
            }
        }

        function toggleManagementModal() {
            const modal = document.getElementById('managementModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
                loadManagementData();
                if (typeof resetItemFormAndUI === 'function') {
                    resetItemFormAndUI();
                } else {
                   clearItemForm();
                }
            }
        }

        function switchManagementTab(tab) {
            currentManagementTab = tab;
            document.querySelectorAll('.management-tab').forEach(t => 
                t.classList.remove('active'));
            
            const itemsView = document.getElementById('itemsManagement');
            const categoriesView = document.getElementById('categoriesManagement');
            const clickedTabButton = event.target;

            if (tab === 'items') {
                if(itemsView) itemsView.style.display = 'block';
                if(categoriesView) categoriesView.style.display = 'none';
            } else {
                if(itemsView) itemsView.style.display = 'none';
                if(categoriesView) categoriesView.style.display = 'block';
            }
            if(clickedTabButton) clickedTabButton.classList.add('active');
        }

        function loadManagementData() {
            const categorySelect = document.getElementById('itemCategory');
            if(categorySelect) {
                categorySelect.innerHTML = Object.keys(menu).map(c => 
                    `<option value="${c}">${c}</option>`).join('');
            }
            
            const itemsList = document.getElementById('existingItems');
            if(itemsList) {
                itemsList.innerHTML = Object.entries(menu).map(([category, itemsInCat]) => 
                    (itemsInCat || []).map(item => `
                        <div class="item-row" id="item-row-${item.id}">
                            <span style="flex:1">${item.name}</span>
                            <span>$${item.price.toFixed(2)}</span>
                            <button onclick="editItem(${item.id})">Edit</button>
                            <button onclick="deleteItem(${item.id})" class="secondary-btn">Delete</button>
                        </div>`
                    ).join('')
                ).join('');
            }
            
            const categoriesList = document.getElementById('existingCategories');
            if(categoriesList) {
                categoriesList.innerHTML = Object.keys(menu).map(c => `
                    <div class="item-row" id="category-row-${c.replace(/\s+/g, '-')}">
                        <span style="flex:1">${c}</span>
                        <button onclick="deleteCategory('${c}')" class="secondary-btn">Delete</button>
                    </div>`
                ).join('');
            }
            if (typeof resetItemFormAndUI === 'function') {
                 resetItemFormAndUI();
            } else {
                clearItemForm();
            }
        }
        
        function addOptionToItemFormTemp() {
            const newOptionNameInput = document.getElementById('newOptionNameInput');
            const optionName = newOptionNameInput.value.trim();
            if (optionName && !tempItemOptions.includes(optionName)) {
                tempItemOptions.push(optionName);
                renderTemporaryOptionsList();
                newOptionNameInput.value = '';
            } else if (tempItemOptions.includes(optionName)) {
                showToast('Option already exists.');
            } else if (!optionName) {
                showToast('Option name cannot be empty.');
            }
        }

        function renderTemporaryOptionsList() {
            const listDisplay = document.getElementById('itemOptionsListDisplay');
            listDisplay.innerHTML = '';

            if (tempItemOptions.length === 0) {
                listDisplay.innerHTML = '<p style="font-style:italic; color:#777; font-size:0.9em; margin:0; width:100%;">No options added yet.</p>';
                return;
            }

            tempItemOptions.forEach(optName => {
                const pillSpan = document.createElement('span');
                pillSpan.className = 'option-pill';
                pillSpan.textContent = optName;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-option-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = `Remove option: ${optName}`;
                removeBtn.onclick = (event) => {
                    event.stopPropagation(); 
                    removeTemporaryOption(optName);
                };
                pillSpan.appendChild(removeBtn);
                listDisplay.appendChild(pillSpan);
            });
        }

        function removeTemporaryOption(optionName) {
            tempItemOptions = tempItemOptions.filter(opt => opt !== optionName);
            renderTemporaryOptionsList();
        }

        function toggleItemOptionsUI() {
            const hasOptionsCheckbox = document.getElementById('itemHasOptions');
            const optionsContainer = document.getElementById('itemOptionsContainer');
            if (optionsContainer) {
                optionsContainer.style.display = hasOptionsCheckbox.checked ? 'grid' : 'none';
                if (!hasOptionsCheckbox.checked) {
                    tempItemOptions = [];
                    renderTemporaryOptionsList(); 
                    const newOptionNameInput = document.getElementById('newOptionNameInput');
                    if (newOptionNameInput) newOptionNameInput.value = '';
                } else {
                    if (tempItemOptions.length === 0) {
                        renderTemporaryOptionsList();
                    }
                }
            }
        }

        function clearItemForm() {
            const itemName = document.getElementById('itemName');
            const itemPrice = document.getElementById('itemPrice');
            const itemId = document.getElementById('itemId');
            const itemCategory = document.getElementById('itemCategory');

            if(itemName) itemName.value = '';
            if(itemPrice) itemPrice.value = '';
            if(itemId) itemId.value = ''; 
            if(itemCategory && itemCategory.options.length > 0) {
                itemCategory.selectedIndex = 0; 
            }
        }

        function resetItemFormAndUI() {
            clearItemForm(); 
            editingItem = null; 

            document.querySelectorAll('#existingItems .item-row.editing').forEach(row => {
                row.classList.remove('editing');
            });

            const saveBtn = document.getElementById('saveItemBtn');
            if (saveBtn) saveBtn.innerHTML = 'üíæ SAVE ITEM';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';

            const hasOptionsCheckbox = document.getElementById('itemHasOptions');
            if (hasOptionsCheckbox) {
                 hasOptionsCheckbox.checked = false;
            }
            toggleItemOptionsUI(); 
        }

        function editItem(itemId) {
            let foundItem;
            let itemCategoryName;

            Object.entries(menu).forEach(([category, itemsInCat]) => {
                const item = (itemsInCat || []).find(i => i.id === itemId);
                if (item) {
                    foundItem = item;
                    itemCategoryName = category;
                }
            });

            if (foundItem) {
                resetItemFormAndUI(); 

                document.getElementById('itemName').value = foundItem.name;
                document.getElementById('itemPrice').value = foundItem.price;
                document.getElementById('itemId').value = foundItem.id;
                document.getElementById('itemCategory').value = itemCategoryName;
                editingItem = { ...foundItem }; 

                const hasOptionsCheckbox = document.getElementById('itemHasOptions');
                if (foundItem.options && Array.isArray(foundItem.options) && foundItem.options.length > 0) {
                    hasOptionsCheckbox.checked = true;
                    tempItemOptions = [...foundItem.options]; 
                } else {
                    hasOptionsCheckbox.checked = false;
                    tempItemOptions = []; 
                }
                toggleItemOptionsUI(); 
                renderTemporaryOptionsList(); 

                document.querySelectorAll('#existingItems .item-row.editing').forEach(row => {
                    row.classList.remove('editing');
                });
                const selectedRow = document.getElementById(`item-row-${itemId}`);
                if (selectedRow) {
                    selectedRow.classList.add('editing');
                }

                document.getElementById('saveItemBtn').innerHTML = 'üîÑ UPDATE ITEM';
                document.getElementById('cancelEditBtn').style.display = 'block';
                document.getElementById('itemName').focus();
            }
        }
        
        async function saveItem() {
            const itemIdValue = document.getElementById('itemId').value;
            const itemData = {
                id: editingItem ? editingItem.id : (itemIdValue ? parseInt(itemIdValue) : generateItemId()),
                name: document.getElementById('itemName').value.trim(),
                price: Number(document.getElementById('itemPrice').value),
                category: document.getElementById('itemCategory').value
            };

            if (!itemData.name || isNaN(itemData.price) || itemData.price < 0 || !itemData.category) {
                return showToast('Please fill all basic fields correctly. Price must be a positive number.');
            }

            const hasOptions = document.getElementById('itemHasOptions').checked;
            if (hasOptions) {
                itemData.options = [...tempItemOptions]; 
                if (!itemData.options || itemData.options.length === 0) {
                    return showToast('Please define at least one option if "Item has options" is checked.');
                }
            } else {
                delete itemData.options; 
            }

            let originalCategoryOfEditingItem = null;
            if (editingItem && editingItem.id) { 
                for (const cat in menu) {
                    if (menu[cat] && menu[cat].some(i => i.id === editingItem.id)) {
                        originalCategoryOfEditingItem = cat;
                        menu[cat] = menu[cat].filter(i => i.id !== editingItem.id);
                        break; 
                    }
                }
            }
            
            if (!menu[itemData.category]) {
                menu[itemData.category] = [];
            }

            const itemToSave = { 
                id: itemData.id, 
                name: itemData.name, 
                price: itemData.price 
            };
            if (itemData.options) { 
                itemToSave.options = itemData.options;
            }
            
            const existingIndexInTargetCategory = menu[itemData.category].findIndex(i => i.id === itemData.id);
            if (existingIndexInTargetCategory > -1) {
                menu[itemData.category][existingIndexInTargetCategory] = itemToSave;
            } else {
                menu[itemData.category].push(itemToSave);
            }
                
            await saveMenuToServer();
            showToast(editingItem ? 'Item updated successfully!' : 'Item saved successfully!');
            
            const categoryOfSavedItem = itemData.category; 
            resetItemFormAndUI(); 
            loadManagementData();   

            if (selectedCategory === categoryOfSavedItem || (editingItem && originalCategoryOfEditingItem === selectedCategory)) {
                 if (menu[selectedCategory] && menu[selectedCategory].length > 0) {
                    showCategory(selectedCategory);
                } else if (Object.keys(menu).length > 0 && Object.values(menu).some(catItems => catItems.length > 0) ) { 
                    const firstCategoryWithItems = Object.keys(menu).find(cat => menu[cat] && menu[cat].length > 0);
                    selectedCategory = firstCategoryWithItems || Object.keys(menu)[0];
                    init(); 
                } else { 
                    selectedCategory = null; 
                    document.getElementById('products').innerHTML = '<p style="text-align: center; width: 100%;">No items to display. Add categories and items in settings.</p>';
                    init(); 
                }
            }
        }

        function deleteItem(itemId) {
            if (!confirm('Delete this item permanently?')) return;
            let itemCategory = null;
            Object.keys(menu).forEach(category => {
                const index = (menu[category] || []).findIndex(i => i.id === itemId);
                if (index > -1) {
                    menu[category].splice(index, 1);
                    itemCategory = category; // Remember the category
                }
            });
            
            saveMenuToServer(); // Save changes to backend
            loadManagementData(); // Reload management list

            // Refresh product view if the deleted item was in the selected category
            if (selectedCategory === itemCategory) {
                showCategory(selectedCategory);
            }
            showToast('Item deleted.');
        }

        async function saveCategory() {
            const categoryName = document.getElementById('categoryName').value.trim();
            if (!categoryName) return showToast('Category name cannot be empty.');
            if (menu[categoryName]) return showToast('Category already exists.');

            menu[categoryName] = [];
            
            await saveMenuToServer();
            loadManagementData();
            
            selectedCategory = categoryName; // Select the new category
            init(); // Re-render category tabs and product display
            showToast(`Category "${categoryName}" added.`);
        }

        function deleteCategory(categoryName) {
            if (menu[categoryName] && menu[categoryName].length > 0) {
                if (!confirm(`Category "${categoryName}" contains items. Delete category and all its items?`)) {
                    return;
                }
            } else if (!confirm(`Delete category "${categoryName}"?`)) {
                return;
            }
        
            delete menu[categoryName];
            saveMenuToServer();
            
            if (selectedCategory === categoryName) {
                selectedCategory = Object.keys(menu)[0] || null;
            }
            init(); // Re-render tabs and products
            loadManagementData(); // Reload management lists
            showToast(`Category "${categoryName}" deleted.`);
        }

        function cancelEditItem() {
            resetItemFormAndUI();
            showToast('Edit cancelled.');
        }

        window.onclick = function(event) {
            const managementModal = document.getElementById('managementModal');
            const optionModal = document.getElementById('itemOptionSelectModal');
            if (event.target === managementModal) {
                managementModal.style.display = 'none';
            }
            if (event.target === optionModal) {
                cancelOptionSelection(); // Use the specific cancel function for this modal
            }
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', duration);
        }
        
        function printKitchenTicket() { 
            const ticketDiv = document.getElementById('kitchenTicket');
            document.getElementById('ticket-number').textContent = orderNumber;
            document.getElementById('ticket-items').innerHTML = currentOrder.map(item =>
                `<div>${item.quantity}x ${item.name}` +
                (item.selectedOption ? ` (${item.selectedOption})` : '') +
                `${item.comment ? ` <small><em>(${item.comment})</em></small>` : ''}</div>`
            ).join('');

            const notesContentEl = document.getElementById('ticket-notes-content');
            if (notesContentEl) {
                notesContentEl.textContent = universalOrderComment || "None";
            }
        }

        initializeOrderNumberAndDate();
        loadMenu();
    
    </script>
    <div class="settings-gear" onclick="toggleManagementModal()">‚öôÔ∏è</div>
	
	<div id="itemOptionSelectModal" class="management-modal" style="display: none;">
    <div class="management-content" style="max-width: 450px;"> 
        <h3 id="optionModalItemName" style="margin-bottom: 0.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Select Option</h3>
        <p id="optionModalItemDescription" style="margin-bottom: 1rem; font-size: 0.9em; color: #555;">Please choose an option for the selected item:</p>
        <div id="optionModalOptionsContainer" style="margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
        </div>
        <div class="form-actions" style="display: flex; justify-content: flex-end; align-items: center; gap: 0.75rem; margin-top: 1rem;">
            <button type="button" class="secondary-btn" onclick="cancelOptionSelection()">Cancel</button>
            <button type="button" id="confirmOptionBtn" class="primary-btn" onclick="confirmOptionSelection()">Confirm</button>
        </div>
    </div>
</div>

<div id="managementModal" class="management-modal">
    <div class="management-content">
        <div class="management-tabs">
            <button class="management-tab active" onclick="switchManagementTab('items')">Manage Items</button>
            <button class="management-tab" onclick="switchManagementTab('categories')">Manage Categories</button>
        </div>

         <div id="itemsManagement">
            <div class="management-form">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="itemName">
                </div>
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" step="0.01" id="itemPrice">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="itemCategory"></select>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                        <input type="checkbox" id="itemHasOptions" onchange="toggleItemOptionsUI()" style="width: auto; height: auto; min-height: auto; margin:0; transform: scale(1.2);">
                        Item has options/variants
                    </label>
                </div>

                <div id="itemOptionsContainer" style="display:none; border: 1px dashed #ccc; padding: 1rem; border-radius: 4px; display: grid; gap: 1rem;">
                    <div class="form-group">
                        <label>Define Option Names (Pills):</label>
                        <div id="itemOptionsListDisplay" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem; padding: 0.5rem; border: 1px solid #eee; min-height: 40px; border-radius: 4px;">
                        </div>
                        <div style="display:flex; gap:0.5rem; margin-top:0.25rem;">
                            <input type="text" id="newOptionNameInput" placeholder="Option name (e.g., Spicy)" style="flex:1;">
                            <button type="button" class="secondary-btn" onclick="addOptionToItemFormTemp()" style="padding: 0.75rem 1rem !important; margin:0 !important; width:auto !important; height:auto !important; min-height:auto !important; font-size: 0.9rem !important;">Add</button>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="itemId"> <div class="form-actions" style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-top: 1rem;">
                    <button id="saveItemBtn" class="primary-btn" onclick="saveItem()" style="padding: 1rem; font-size: 1.1rem;">
                        üíæ SAVE ITEM
                    </button>
                    <button id="cancelEditBtn" class="secondary-btn" onclick="cancelEditItem()" style="display:none; padding: 1rem; font-size: 1.1rem;">
                        ‚úñÔ∏è CANCEL EDIT
                    </button>
                </div>
            </div> <div class="item-list" id="existingItems">
                </div>
        </div>

        <!-- Categories Management -->
        <div id="categoriesManagement" style="display: none;">
            <div class="management-form">
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="categoryName">
                </div>
                <button class="primary-btn" onclick="saveCategory()" style="padding: 1rem; font-size: 1.1rem;">
					üìÅ SAVE CATEGORY
				</button>
            </div>
            
            <div class="item-list" id="existingCategories"></div>
        </div>
        
        <div id="kitchenTicket" class="kitchen-ticket print-section">
			<h2>Order #<span id="ticket-number">1</span></h2>
			<div id="ticket-items"></div>
			<div id="ticket-notes">Notes: <span id="ticket-notes-content"></span></div> <div id="ticket-time"></div>
		</div>
        
    </div>
</div>
</body>
</html>